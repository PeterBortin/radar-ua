<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Defense Elite v12.1</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
    <style>
        :root { --primary: #00ff88; --bg: #0a0c10; --panel-bg: rgba(15, 20, 30, 0.95); }
        body, html { height: 100%; width: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; margin: 0; color: white; }
        #map { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 1; }
        
        .radar-sweep {
            position: absolute; border-radius: 50%;
            background: conic-gradient(from 0deg at 50% 50%, rgba(0, 255, 136, 0.15) 0deg, transparent 90deg);
            animation: rotateRadarReverse 4s linear infinite;
            pointer-events: none; border: 1px solid rgba(0, 255, 136, 0.1);
            transform: translate(-50%, -50%);
        }
        @keyframes rotateRadarReverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

        .explosion {
            position: absolute; width: 60px; height: 60px;
            background: radial-gradient(circle, #fff 10%, #00ff88 30%, transparent 70%);
            border-radius: 50%; z-index: 10001; animation: explode 0.5s ease-out forwards;
            pointer-events: none; transform: translate(-50%, -50%);
        }
        @keyframes explode { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(3); opacity: 0; } }

        .event-marker { display: flex; align-items: center; justify-content: center; filter: drop-shadow(0 0 5px rgba(0,0,0,0.8)); }

        .status-header { position: absolute; top: 0; left: 0; width: 100%; z-index: 9999; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); padding: 12px; display: flex; justify-content: center; gap: 25px; pointer-events: none; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; }
        .ui-layer { position: absolute; top: 50px; width: 100%; z-index: 9998; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .ui-layer > * { pointer-events: auto; }
        .tool-card { background: var(--panel-bg); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; flex: 1; cursor: pointer; }
        .tool-card.active { border-color: var(--primary); }
        .obj-toolbar { position: absolute; background: rgba(0, 10, 20, 0.9); color: #00ffaa; padding: 4px 10px; border-left: 3px solid #00ffaa; font-family: monospace; font-size: 10px; pointer-events: none; z-index: 10000; transform: translate(15px, -15px); white-space: nowrap; }
        .bottom-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 9998; }
        .btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; background: #333; }
        .btn-confirm { background: #28a745 !important; transform: scale(1.1); }
        select { background: #1a222d; color: white; border: 1px solid #444; padding: 8px; border-radius: 6px; width: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<div class="status-header">
    <div class="status-item"><i class="far fa-clock"></i> <span id="simTime">00:00</span></div>
    <div class="status-item"><i class="fas fa-bullseye"></i> <span id="targetCount">0</span></div>
    <div class="status-item"><i class="fas fa-shield-alt"></i> <span id="pvoCount">0</span></div>
</div>
<div class="ui-layer">
    <div style="display: flex; gap: 10px; width: 95%; max-width: 600px;">
        <div class="tool-card active" id="pvoCard" onclick="setMode('pvo')">
            <span style="font-size:9px; color:#888;">СИСТЕМА ОБОРОНЫ</span>
            <select id="pvoSelect">
                <option value="pvo_pancyr">Панцирь-С1 (20 км)</option>
                <option value="pvo_iris">IRIS-T SLM (40 км)</option>
                <option value="pvo_buk">Бук-М3 (70 км)</option>
                <option value="pvo_samp">SAMP/T (100 км)</option>
                <option value="pvo_patriot">Patriot PAC-3 (160 км)</option>
                <option value="pvo_s400">С-400 (400 км)</option>
            </select>
        </div>
        <div class="tool-card" id="targetCard" onclick="setMode('target')">
            <span style="font-size:9px; color:#888;">ТИП УГРОЗЫ</span>
            <select id="targetSelect">
                <option value="drone_shahed">Shahed-136 (185 км/ч)</option>
                <option value="missile_x101">Х-101 (850 км/ч)</option>
                <option value="missile_iskander">Искандер-М (7500 км/ч)</option>
                <option value="missile_x32">Х-32 (5400 км/ч)</option>
                <option value="missile_zircon">Циркон (11000 км/ч)</option>
            </select>
        </div>
    </div>
</div>
<div class="bottom-nav">
    <button class="btn" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
    <button class="btn" id="playBtn" style="background:#1a73e8;"><i class="fas fa-play"></i></button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const Snd = {
        ctx: null,
        init() { if(!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } if(this.ctx.state === 'suspended') this.ctx.resume(); },
        osc(f, t, d, v) {
            const o = this.ctx.createOscillator(), g = this.ctx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
            g.gain.setValueAtTime(v, this.ctx.currentTime);
            g.gain.setTargetAtTime(0.0001, this.ctx.currentTime, d/3);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(); o.stop(this.ctx.currentTime + d);
        },
        launch() { this.init(); this.osc(300, 'sawtooth', 0.4, 0.05); this.osc(100, 'sine', 0.4, 0.1); },
        intercept() { this.init(); this.osc(60, 'sine', 0.8, 0.3); this.osc(1200, 'sine', 0.1, 0.05); },
        hit() { this.init(); this.osc(40, 'triangle', 1.0, 0.4); },
        ping() { this.init(); this.osc(1000, 'sine', 0.05, 0.02); }
    };

    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.8, 36.5], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const CONFIG = {
        drone_shahed: { name: 'SHAHED-136', speed: 185, color: '#00ff88' },
        missile_x101: { name: 'KH-101', speed: 850, color: '#ffbb33' },
        missile_iskander: { name: 'ISKANDER-M', speed: 7500, color: '#ff4444' },
        missile_x32: { name: 'KH-32', speed: 5400, color: '#ff00ff' },
        missile_zircon: { name: 'ZIRCON', speed: 11000, color: '#ff0000' },
        pvo_pancyr: { r: 20, s: 4600 }, pvo_iris: { r: 40, s: 3700 },
        pvo_buk: { r: 70, s: 5600 }, pvo_samp: { r: 100, s: 5000 },
        pvo_patriot: { r: 160, s: 6000 }, pvo_s400: { r: 400, s: 9000 }
    };

    let state = { currentMode: 'pvo', isSimulating: false, targets: [], pvo: [], missiles: [], pendingPath: [], tempMarkers: [], activeFutureLine: null, simSeconds: 0, lastFrame: 0 };

    function setMode(m) {
        state.currentMode = m;
        document.getElementById('pvoCard').classList.toggle('active', m === 'pvo');
        document.getElementById('targetCard').classList.toggle('active', m === 'target');
    }

    map.on('click', (e) => {
        Snd.init();
        const pos = [e.latlng.lat, e.latlng.lng];
        if (state.currentMode === 'pvo') {
            const cfg = CONFIG[document.getElementById('pvoSelect').value];
            const rMarker = L.marker(pos, { icon: L.divIcon({ className: 'radar-container', html: `<div class="radar-sweep" style="width:${cfg.r*2.4}px; height:${cfg.r*2.4}px;"></div>`, iconSize:[0,0] }), interactive: false }).addTo(map);
            const dot = L.circleMarker(pos, { radius: 6, color: '#fff', fillColor: '#00ff88', fillOpacity: 1 }).addTo(map);
            const range = L.circle(pos, { radius: cfg.r * 1000, color: '#00ff88', weight: 1, fillOpacity: 0.03, dashArray: '5, 10' }).addTo(map);
            state.pvo.push({ id: Math.random(), pos, radius: cfg.r, mSpeed: cfg.s, layers: [rMarker, dot, range] });
        } else {
            state.pendingPath.push(pos);
            state.tempMarkers.push(L.circleMarker(pos, { radius: 4, color: '#fff' }).addTo(map));
            if(state.activeFutureLine) map.removeLayer(state.activeFutureLine);
            state.activeFutureLine = L.polyline(state.pendingPath, { color: '#fff', weight: 1, dashArray: '5, 8', opacity: 0.5 }).addTo(map);
        }
        updateCounters(); updateNav();
    });

    function simLoop(time) {
        if (!state.isSimulating) return;
        const dt = (time - state.lastFrame) / 1000; state.lastFrame = time;
        const stepHours = (dt * 15) / 3600;

        state.targets.forEach(t => {
            if (!t.active) return;
            t.progressKm += t.speed * stepHours;
            if (t.progressKm >= t.totalDist) { 
                Snd.hit(); 
                markEvent(t.currentPos, 'hit'); 
                removeT(t); 
            } else {
                t.currentPos = interpolate(t.path, t.progressKm);
                t.marker.setLatLng(t.currentPos);
                t.linePast.setLatLngs(getPastPoints(t.path, t.progressKm, t.currentPos));
                const p = map.latLngToContainerPoint(t.currentPos);
                t.toolbar.style.left = p.x + 'px'; t.toolbar.style.top = p.y + 'px';
                t.toolbar.innerHTML = `${t.name} | ${Math.round(t.speed)} KM/H`;
            }
        });

        state.pvo.forEach(p => {
            state.targets.forEach(t => {
                if (t.active && !t.engagedBy.has(p.id)) {
                    if ((map.distance(p.pos, t.currentPos) / 1000) < p.radius) {
                        t.engagedBy.add(p.id); Snd.ping(); Snd.launch();
                        const mMarker = L.circleMarker(p.pos, { radius: 3, color: '#fff', fillColor: '#ffbb33', fillOpacity: 1 }).addTo(map);
                        state.missiles.push({ target: t, pos: [...p.pos], speed: p.mSpeed, marker: mMarker });
                    }
                }
            });
        });

        state.missiles = state.missiles.filter(m => {
            if (!m.target.active) { map.removeLayer(m.marker); return false; }
            const d = map.distance(m.pos, m.target.currentPos);
            if (d < 1200) { 
                Snd.intercept(); 
                markEvent(m.target.currentPos, 'intercept'); 
                removeT(m.target); map.removeLayer(m.marker); 
                confetti({ particleCount: 40, origin: { y: 0.7 } }); return false; 
            }
            const move = (m.speed * stepHours * 1000) / d;
            m.pos = [m.pos[0] + (m.target.currentPos[0] - m.pos[0]) * move, m.pos[1] + (m.target.currentPos[1] - m.pos[1]) * move];
            m.marker.setLatLng(m.pos); return true;
        });

        state.simSeconds += dt * 15; updateClock();
        requestAnimationFrame(simLoop);
    }

    function markEvent(pos, type) {
        const icon = L.divIcon({
            className: 'event-marker',
            html: type === 'intercept' ? '<i class="fas fa-skull" style="color:white; font-size:20px;"></i>' : '<i class="fas fa-certificate" style="color:#ffbb33; font-size:20px;"></i>',
            iconSize: [24, 24]
        });
        L.marker(pos, { icon }).addTo(map);
        const p = map.latLngToContainerPoint(pos);
        const d = document.createElement('div'); d.className = 'explosion'; d.style.left = p.x + 'px'; d.style.top = p.y + 'px';
        document.body.appendChild(d); setTimeout(() => d.remove(), 500);
    }

    function getPastPoints(path, dist, current) {
        let acc = 0, res = [];
        for(let i=0; i<path.length-1; i++) {
            const d = map.distance(path[i], path[i+1])/1000;
            res.push(path[i]); if(acc+d > dist) break; acc += d;
        }
        res.push(current); return res;
    }

    function interpolate(path, dist) {
        let acc = 0;
        for (let i = 0; i < path.length - 1; i++) {
            const d = map.distance(path[i], path[i+1]) / 1000;
            if (acc + d > dist) { const r = (dist - acc) / d; return [path[i][0] + (path[i+1][0] - path[i][0]) * r, path[i][1] + (path[i+1][1] - path[i][1]) * r]; }
            acc += d;
        }
        return path[path.length-1];
    }

    function removeT(t) { t.active = false; map.removeLayer(t.marker); if(t.lineFuture) map.removeLayer(t.lineFuture); t.toolbar.remove(); updateCounters(); }

    document.getElementById('playBtn').onclick = () => {
        Snd.init();
        if (state.pendingPath.length > 1) {
            const type = document.getElementById('targetSelect').value;
            const t = {
                id: Math.random(), name: CONFIG[type].name, path: [...state.pendingPath], speed: CONFIG[type].speed, currentPos: state.pendingPath[0], progressKm: 0, totalDist: 0, active: true, engagedBy: new Set(),
                toolbar: Object.assign(document.createElement('div'), {className:'obj-toolbar'}),
                marker: L.circleMarker(state.pendingPath[0], { radius: 6, color: '#fff', fillColor: CONFIG[type].color, fillOpacity: 1 }).addTo(map),
                linePast: L.polyline([], { color: CONFIG[type].color, weight: 3 }).addTo(map),
                lineFuture: state.activeFutureLine
            };
            document.body.appendChild(t.toolbar);
            for(let i=0; i<t.path.length-1; i++) t.totalDist += map.distance(t.path[i], t.path[i+1])/1000;
            state.targets.push(t); state.tempMarkers.forEach(m => map.removeLayer(m));
            state.pendingPath = []; state.tempMarkers = []; state.activeFutureLine = null;
            updateNav(); updateCounters();
        } else {
            state.isSimulating = !state.isSimulating; state.lastFrame = performance.now();
            document.getElementById('playBtn').innerHTML = state.isSimulating ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            if (state.isSimulating) requestAnimationFrame(simLoop);
        }
    };

    function updateCounters() { 
        document.getElementById('targetCount').innerText = state.targets.filter(x => x.active).length; 
        document.getElementById('pvoCount').innerText = state.pvo.length; 
    }
    function updateClock() {
        const m = Math.floor(state.simSeconds/60), s = Math.floor(state.simSeconds%60);
        document.getElementById('simTime').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function updateNav() {
        const btn = document.getElementById('playBtn');
        if(state.pendingPath.length > 0) { btn.innerHTML = '<i class="fas fa-check"></i>'; btn.className = 'btn btn-confirm'; }
        else { btn.innerHTML = state.isSimulating ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; btn.className = 'btn'; }
    }
</script>
</body>
</html>
