<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–¢–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ -- –ë–ü–õ–ê / –ö–† / –ë–†</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

<style>
html,body{margin:0;padding:0;height:100%;background:#111;font-family:'Segoe UI',Arial,sans-serif;}
#map{height:100%;width:100%;}

/* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.control-panel{
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(20,20,20,0.95);
  backdrop-filter:blur(8px);
  border-radius:60px;
  padding:15px 30px;
  border:1px solid #3a3a3a;
  box-shadow:0 8px 20px rgba(0,0,0,0.8);
  z-index:1000;
  display:flex;
  gap:25px;
  align-items:center;
  font-size:13px;
  flex-wrap:wrap;
  justify-content:center;
}

/* –ë–ª–æ–∫ —Ü–µ–ª–∏ */
.target-group {
  display:flex;
  gap:15px;
  background:#1a1a1a;
  border-radius:40px;
  padding:8px 20px;
  border:1px solid #333;
  align-items:center;
}

.group-label {
  color:#ffaa00;
  font-weight:bold;
  display:flex;
  align-items:center;
  gap:5px;
}

.target-option select {
  background:#2a2a2a;
  color:white;
  border:1px solid #444;
  border-radius:30px;
  padding:8px 15px;
  font-size:12px;
  cursor:pointer;
  outline:none;
  min-width:130px;
}

.target-option select:hover {
  background:#333;
  border-color:#666;
}

/* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */
.specs {
  display:flex;
  gap:15px;
  color:#ccc;
  font-size:11px;
  background:#1e1e1e;
  padding:5px 15px;
  border-radius:30px;
  border:1px solid #333;
}

.spec-item {
  display:flex;
  align-items:center;
  gap:5px;
}

.spec-item i {
  color:#ffaa00;
  width:16px;
}

/* –°—á–µ—Ç—á–∏–∫ —Ç–æ—á–µ–∫ */
.points-badge {
  background:#ffaa00;
  color:#111;
  border-radius:20px;
  padding:4px 12px;
  font-size:12px;
  font-weight:bold;
  white-space:nowrap;
}

/* –ö–Ω–æ–ø–∫–∏ */
.action-group{
  display:flex;
  gap:8px;
}

.action-group button{
  background:#1e1e1e;
  border:1px solid #444;
  color:#eee;
  border-radius:40px;
  padding:10px 30px;
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  transition:0.15s;
}

.action-group button:hover{
  background:#2d2d2d;
  border-color:#777;
}

#startBtn {
  background: #2d5a8c;
  border-color: #4a7aac;
  min-width: 140px;
  justify-content: center;
}

#startBtn:hover {
  background: #3a6a9c;
}

#resetBtn {
  background: #5a2d2d;
  border-color: #8c4a4a;
}

#resetBtn:hover {
  background: #6a3a3a;
}

/* –ö–Ω–æ–ø–∫–∏ –∑—É–º–∞ */
.zoom-ui{
  position:absolute;
  bottom:100px;
  right:20px;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:1000;
}

.zoom-ui button{
  width:40px;
  height:40px;
  border-radius:40px;
  background:rgba(20,20,20,0.85);
  backdrop-filter:blur(8px);
  border:1px solid #444;
  color:white;
  font-size:16px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:0.15s;
}

.zoom-ui button:hover{background:#2d2d2d;border-color:#777;}

/* –¢—É–ª—Ç–∏–ø—ã —Ü–µ–ª–µ–π */
.tooltip{
  position:absolute;
  background:rgba(30,30,30,0.9);
  color:#eee;
  padding:4px 12px;
  border-radius:20px;
  font-size:11px;
  pointer-events:none;
  white-space:nowrap;
  z-index:2000;
  backdrop-filter:blur(2px);
  border:1px solid #444;
  box-shadow:0 2px 6px black;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-corner {
  position:absolute;
  top:20px;
  left:20px;
  background:rgba(20,20,20,0.8);
  backdrop-filter:blur(4px);
  border-radius:30px;
  padding:8px 16px;
  border:1px solid #333;
  color:#eee;
  font-size:12px;
  display:flex;
  gap:20px;
  z-index:1000;
}

.stat-item {
  display:flex;
  align-items:center;
  gap:8px;
}

.stat-item i {
  color:#ffaa00;
}

.stat-value {
  font-weight:bold;
  color:white;
}

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
.hint {
  position:absolute;
  top:20px;
  right:20px;
  background:rgba(0,0,0,0.7);
  color:#ccc;
  padding:8px 15px;
  border-radius:30px;
  font-size:12px;
  border:1px solid #333;
  z-index:1000;
}

.hint i {
  color:#ffaa00;
  margin-right:5px;
}

@media(max-width:1000px){
  .control-panel{flex-direction:column;border-radius:30px;width:95%;padding:15px;}
  .target-group{flex-wrap:wrap;}
  .zoom-ui{bottom:220px;}
}
</style>
</head>
<body>

<div id="map"></div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-corner">
  <div class="stat-item">
    <i class="fas fa-bullseye"></i>
    <span>–¶–µ–ª–∏: <span class="stat-value" id="targetCount">0</span></span>
  </div>
  <div class="stat-item">
    <i class="fas fa-clock"></i>
    <span>–í—Ä–µ–º—è: <span class="stat-value" id="simTime">00:00</span></span>
  </div>
</div>

<!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
<div class="hint">
  <i class="fas fa-mouse-pointer"></i> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –∑—É–º–∞ -->
<div class="zoom-ui">
  <button onclick="map.zoomIn()"><i class="fas fa-plus"></i></button>
  <button onclick="map.zoomOut()"><i class="fas fa-minus"></i></button>
</div>

<!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="control-panel">
  <!-- –ë–ª–æ–∫ –¶–ï–õ–ò -->
  <div class="target-group">
    <span class="group-label"><i class="fas fa-bullseye"></i> –¶–µ–ª—å:</span>
    <div class="target-option">
      <select id="targetTypeSelect">
        <option value="drone">üöÅ –ë–ü–õ–ê (80-300 –∫–º/—á)</option>
        <option value="cr">‚ö° –ö—Ä—ã–ª–∞—Ç–∞—è —Ä–∞–∫–µ—Ç–∞ (700-1200 –∫–º/—á)</option>
        <option value="br">üî• –ë–∞–ª–ª–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∫–µ—Ç–∞ (3000-10000 –∫–º/—á)</option>
      </select>
    </div>
    <div class="target-option">
      <select id="targetSpeedSelect"></select>
    </div>
    <div id="waypointBadge" class="points-badge">0 —Ç–æ—á–µ–∫</div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div class="action-group">
    <button id="startBtn" onclick="toggleSimulation()">
      <i class="fas fa-play"></i> –°—Ç–∞—Ä—Ç
    </button>
    <button id="resetBtn" onclick="resetAll()">
      <i class="fas fa-stop"></i> –°–±—Ä–æ—Å
    </button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ==========
const TIME_SCALE = 60; // —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ 60 —Ä–∞–∑
const map = L.map('map', {zoomControl: false}).setView([50, 30], 6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '¬© OpenStreetMap, ¬© CartoDB'
}).addTo(map);

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ==========
let activeTargets = [];          // –∞–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏
let pendingWaypoints = [];       // –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ü–µ–ª–∏
let pendingMarkers = [];         // –º–∞—Ä–∫–µ—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
let simulationActive = false;    // —Ñ–ª–∞–≥, —á—Ç–æ —Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞
let simulationStartTime = null;  // –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ —Å–∏–º—É–ª—è—Ü–∏–∏
let animationFrame = null;       // –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ü–µ–ª–∏
let pendingTargetParams = {
  type: 'drone',
  speed: 80
};

// –¢–∏–ø—ã —Ü–µ–ª–µ–π
const targetTypes = {
  drone: { 
    name: '–ë–ü–õ–ê', 
    color: '#00ffff', 
    speedOptions: [80, 150, 300], 
    icon: 'fa-drone',
    radius: 40,        // –∫–º
    maxPoints: 10      // –º–æ–∂–Ω–æ –º–Ω–æ–≥–æ —Ç–æ—á–µ–∫
  },
  cr: { 
    name: '–ö–†', 
    color: '#ffaa00', 
    speedOptions: [700, 900, 1200], 
    icon: 'fa-rocket',
    radius: 120,
    maxPoints: 10
  },
  br: { 
    name: '–ë–†', 
    color: '#ff4444', 
    speedOptions: [3000, 5000, 10000], 
    icon: 'fa-bomb',
    radius: 300,
    maxPoints: 2       // —Ç–æ–ª—å–∫–æ 2 —Ç–æ—á–∫–∏
  }
};

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
function updateSpeedSelect() {
  const targetType = document.getElementById('targetTypeSelect').value;
  const speedSelect = document.getElementById('targetSpeedSelect');
  
  pendingTargetParams.type = targetType;
  speedSelect.innerHTML = '';
  
  targetTypes[targetType].speedOptions.forEach(speed => {
    const option = document.createElement('option');
    option.value = speed;
    option.textContent = speed + ' –∫–º/—á';
    if (speed === pendingTargetParams.speed) option.selected = true;
    speedSelect.appendChild(option);
  });

  // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –±–µ—Ä—ë–º –ø–µ—Ä–≤—É—é
  if (!targetTypes[targetType].speedOptions.includes(pendingTargetParams.speed)) {
    pendingTargetParams.speed = targetTypes[targetType].speedOptions[0];
    speedSelect.value = pendingTargetParams.speed;
  }
  
  updateWaypointBadge();
}

function updateWaypointBadge() {
  const badge = document.getElementById('waypointBadge');
  const targetType = document.getElementById('targetTypeSelect').value;
  const maxPoints = targetTypes[targetType].maxPoints;
  
  if (pendingWaypoints.length > 0) {
    badge.textContent = `${pendingWaypoints.length}/${maxPoints} —Ç–æ—á–µ–∫`;
    badge.style.background = pendingWaypoints.length >= maxPoints ? '#ff5555' : '#ffaa00';
  } else {
    badge.textContent = '0 —Ç–æ—á–µ–∫';
    badge.style.background = '#ffaa00';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ —Ü–µ–ª–µ–π
function updateStats() {
  document.getElementById('targetCount').textContent = activeTargets.length;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–º—É–ª—è—Ü–∏–∏
function updateSimulationTime() {
  if (!simulationActive || !simulationStartTime) return;
  
  const now = performance.now();
  const simHours = ((now - simulationStartTime) / 1000 / 3600) * TIME_SCALE;
  const totalSec = Math.floor(simHours * 3600);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  
  document.getElementById('simTime').textContent = 
    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
  
  animationFrame = requestAnimationFrame(updateSimulationTime);
}

// ========== –ö–õ–ò–ö –ü–û –ö–ê–†–¢–ï ==========
map.on('click', function(e) {
  const latlng = [e.latlng.lat, e.latlng.lng];
  
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø —Ü–µ–ª–∏
  const targetType = document.getElementById('targetTypeSelect').value;
  const maxPoints = targetTypes[targetType].maxPoints;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ç–æ—á–µ–∫
  if (pendingWaypoints.length >= maxPoints) {
    alert(`–ú–∞–∫—Å–∏–º—É–º ${maxPoints} —Ç–æ—á–∫–∏ –¥–ª—è ${targetTypes[targetType].name}`);
    return;
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞
  pendingWaypoints.push(latlng);
  
  const color = targetTypes[targetType].color;
  const marker = L.circleMarker(latlng, {
    radius: 6,
    color: color,
    fillColor: color,
    fillOpacity: 0.9,
    weight: 2
  }).addTo(map);
  
  pendingMarkers.push(marker);
  updateWaypointBadge();
});

// ========== –°–û–ó–î–ê–ù–ò–ï –¶–ï–õ–ò ==========
function createTarget(type, speed, waypoints) {
  const color = targetTypes[type].color;
  const target = {
    id: Date.now() + Math.random(),
    type: type,
    waypoints: waypoints,
    speed: speed,
    color: color,
    position: waypoints[0],
    marker: L.circleMarker(waypoints[0], {
      radius: 8,
      color: color,
      fillColor: color,
      fillOpacity: 1,
      weight: 2
    }).addTo(map),
    pathLine: L.polyline(waypoints, {
      color: color,
      opacity: 0.3,
      weight: 2,
      dashArray: '5,5'
    }).addTo(map),
    totalDistance: calculateTotalDistance(waypoints),
    active: true,
    intercepted: false,
    tooltip: createTooltip(waypoints[0]),
    progress: 0,        // –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–º
    lastUpdate: performance.now()
  };

  if (simulationActive) {
    startTargetMovement(target);
  }

  return target;
}

// ========== –ó–ê–ü–£–°–ö –¶–ï–õ–ò ==========
function addTarget() {
  if (pendingWaypoints.length < 2) {
    alert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞');
    return false;
  }

  // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  const targetType = document.getElementById('targetTypeSelect').value;
  const speed = parseInt(document.getElementById('targetSpeedSelect').value);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  pendingTargetParams.type = targetType;
  pendingTargetParams.speed = speed;

  // –°–æ–∑–¥–∞—ë–º —Ü–µ–ª—å
  const target = createTarget(targetType, speed, [...pendingWaypoints]);
  activeTargets.push(target);

  // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
  pendingMarkers.forEach(m => map.removeLayer(m));
  pendingMarkers = [];
  pendingWaypoints = [];

  updateWaypointBadge();
  updateStats();
  
  return true;
}

// ========== –ó–ê–ü–£–°–ö –î–í–ò–ñ–ï–ù–ò–Ø –¶–ï–õ–ò ==========
function startTargetMovement(target) {
  if (!target.active || target.intercepted) return;
  
  target.lastUpdate = performance.now();
  
  function moveFrame() {
    if (!target.active || target.intercepted || !simulationActive) return;
    
    const now = performance.now();
    const dtHours = ((now - target.lastUpdate) / 1000 / 3600) * TIME_SCALE;
    target.lastUpdate = now;
    
    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –∑–∞ —ç—Ç–æ—Ç –∫–∞–¥—Ä
    const segmentKm = target.speed * dtHours;
    target.progress += segmentKm;
    
    if (target.progress >= target.totalDistance) {
      // –î–æ—Å—Ç–∏–≥–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
      finishTarget(target);
      return;
    }
    
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
    let accumulated = 0;
    for (let i = 0; i < target.waypoints.length - 1; i++) {
      const segmentDist = getDistance(target.waypoints[i], target.waypoints[i+1]);
      if (accumulated + segmentDist >= target.progress) {
        const ratio = (target.progress - accumulated) / segmentDist;
        const lat = target.waypoints[i][0] + (target.waypoints[i+1][0] - target.waypoints[i][0]) * ratio;
        const lng = target.waypoints[i][1] + (target.waypoints[i+1][1] - target.waypoints[i][1]) * ratio;
        
        target.position = [lat, lng];
        target.marker.setLatLng([lat, lng]);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø
        const point = map.latLngToContainerPoint([lat, lng]);
        target.tooltip.style.left = (point.x + 12) + 'px';
        target.tooltip.style.top = (point.y - 25) + 'px';
        
        const totalSec = Math.floor((target.progress / target.speed) * 3600);
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        target.tooltip.innerHTML = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} | ${target.speed} –∫–º/—á`;
        
        break;
      }
      accumulated += segmentDist;
    }
    
    requestAnimationFrame(moveFrame);
  }
  
  moveFrame();
}

// ========== –ó–ê–í–ï–†–®–ï–ù–ò–ï –ú–ê–†–®–†–£–¢–ê ==========
function finishTarget(target) {
  target.active = false;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–Ω—É –ø–æ—Ä–∞–∂–µ–Ω–∏—è
  L.circle(target.position, {
    radius: targetTypes[target.type].radius * 1000,
    color: target.color,
    fillColor: target.color,
    fillOpacity: 0.2,
    weight: 2
  }).addTo(map);
  
  // –≠—Ñ—Ñ–µ–∫—Ç –≤–∑—Ä—ã–≤–∞
  createExplosion(target.position, target.color);
  
  // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(() => {
    map.removeLayer(target.marker);
    map.removeLayer(target.pathLine);
    if (target.tooltip) document.body.removeChild(target.tooltip);
  }, 2000);
  
  // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
  activeTargets = activeTargets.filter(t => t !== target);
  updateStats();
}

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–ú–£–õ–Ø–¶–ò–ï–ô ==========
function toggleSimulation() {
  if (!simulationActive) {
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
    simulationActive = true;
    simulationStartTime = performance.now();
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-pause"></i> –ü–∞—É–∑–∞';
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏
    updateSimulationTime();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ü–µ–ª–µ–π
    activeTargets.forEach(target => {
      if (!target.intercepted && target.active) {
        target.lastUpdate = performance.now();
        startTargetMovement(target);
      }
    });
    
  } else {
    // –°—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
    simulationActive = false;
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> –°—Ç–∞—Ä—Ç';
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }
  }
}

// ========== –°–ë–†–û–° –í–°–ï–ì–û ==========
function resetAll() {
  if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ü–µ–ª–∏?')) {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ü–µ–ª–∏
    activeTargets.forEach(t => {
      map.removeLayer(t.marker);
      map.removeLayer(t.pathLine);
      if (t.tooltip) document.body.removeChild(t.tooltip);
    });
    activeTargets = [];

    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
    pendingMarkers.forEach(m => map.removeLayer(m));
    pendingMarkers = [];
    pendingWaypoints = [];

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
    simulationActive = false;
    simulationStartTime = null;
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> –°—Ç–∞—Ä—Ç';
    document.getElementById('simTime').textContent = '00:00';
    
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }

    updateWaypointBadge();
    updateStats();
  }
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function createTooltip(latlng) {
  const div = document.createElement('div');
  div.className = 'tooltip';
  div.style.left = '0px';
  div.style.top = '0px';
  div.innerHTML = '0:00:00 | 0 –∫–º/—á';
  document.body.appendChild(div);
  return div;
}

function calculateTotalDistance(points) {
  let total = 0;
  for(let i = 0; i < points.length - 1; i++) {
    total += getDistance(points[i], points[i+1]);
  }
  return total;
}

function getDistance(a, b) {
  const R = 6371; // —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
  const dLat = (b[0] - a[0]) * Math.PI / 180;
  const dLon = (b[1] - a[1]) * Math.PI / 180;
  const lat1 = a[0] * Math.PI / 180;
  const lat2 = b[0] * Math.PI / 180;

  const x = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
  const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
  return R * c;
}

function createExplosion(position, color) {
  for(let i = 0; i < 15; i++) {
    const angle = Math.random() * 2 * Math.PI;
    const dist = Math.random() * 8000 / 111000; // –¥–æ 8 –∫–º –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    const particle = L.circleMarker([
      position[0] + Math.sin(angle) * dist,
      position[1] + Math.cos(angle) * dist
    ], {
      radius: Math.random() * 8 + 2,
      color: color,
      fillColor: color,
      fillOpacity: 0.8
    }).addTo(map);
    setTimeout(() => map.removeLayer(particle), 300);
  }
}

// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
document.getElementById('targetTypeSelect').addEventListener('change', function(e) {
  updateSpeedSelect();
  
  // –û—á–∏—â–∞–µ–º —Ç–æ—á–∫–∏, –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Ç–∏–ø –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å —Ç–µ–∫—É—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
  const newType = e.target.value;
  const maxPoints = targetTypes[newType].maxPoints;
  
  if (pendingWaypoints.length > maxPoints) {
    // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —Ç–æ—á–∫–∏
    const toRemove = pendingWaypoints.length - maxPoints;
    for (let i = 0; i < toRemove; i++) {
      const marker = pendingMarkers.pop();
      map.removeLayer(marker);
      pendingWaypoints.pop();
    }
    alert(`–û—Å—Ç–∞–≤–ª–µ–Ω–æ ${maxPoints} —Ç–æ—á–µ–∫ –¥–ª—è ${targetTypes[newType].name}`);
  }
  
  updateWaypointBadge();
});

document.getElementById('targetSpeedSelect').addEventListener('change', function(e) {
  pendingTargetParams.speed = parseInt(e.target.value);
});

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ä—Ç" - —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Ü–µ–ª—å
document.getElementById('startBtn').onclick = function() {
  // –°–æ–∑–¥–∞—ë–º —Ü–µ–ª—å –∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ç–æ—á–µ–∫
  if (pendingWaypoints.length >= 2) {
    addTarget();
  }
  // –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
  if (!simulationActive && activeTargets.length > 0) {
    toggleSimulation();
  } else if (simulationActive) {
    toggleSimulation();
  }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
updateSpeedSelect();
updateStats();

// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ü–µ–ª–∏
console.log('–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫, –∑–∞—Ç–µ–º –°—Ç–∞—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞');
</script>
</body>
</html>