<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Defense Elite v9.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
    <style>
        :root { --primary: #ffbb33; --bg: #0a0c10; --panel-bg: rgba(15, 20, 30, 0.95); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { height: 100%; width: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Исправленная яркость карты */
        #map { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 1; filter: contrast(1.1); }
        
        .status-header { 
            position: absolute; top: 0; left: 0; width: 100%; z-index: 9999; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); 
            padding: 15px; display: flex; justify-content: center; gap: 30px; color: white; pointer-events: none;
        }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        .status-item i { color: var(--primary); }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        .ui-layer > * { pointer-events: auto; }
        
        .tool-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; margin: 60px auto 0 auto; }
        .tool-card { background: var(--panel-bg); border: 1px solid rgba(255,187,51,0.4); border-radius: 12px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        .card-label { font-size: 11px; color: var(--primary); font-weight: 900; margin-bottom: 8px; display: block; text-transform: uppercase; }
        
        .tool-card label { display: flex; align-items: center; gap: 10px; color: #eee; font-size: 12px; cursor: pointer; padding: 5px; border-radius: 4px; }
        .tool-card input { accent-color: var(--primary); }
        
        .obj-toolbar { 
            position: absolute; background: rgba(0, 10, 20, 0.9); color: #00ffaa; 
            padding: 4px 10px; border-left: 3px solid #00ffaa; border-radius: 2px; 
            font-family: 'Courier New', monospace; font-size: 10px; pointer-events: none; 
            z-index: 10000; white-space: nowrap; transform: translate(15px, -15px);
        }

        .bottom-nav { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .btn { width: 55px; height: 55px; border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s; }
        #playBtn { background: #1a73e8; }
        #resetBtn { background: #444; }
        .btn:active { transform: scale(0.9); }
    </style>
</head>
<body>
<div id="map"></div>
<div class="status-header">
    <div class="status-item"><i class="far fa-clock"></i> <span id="simTime">00:00</span></div>
    <div class="status-item"><i class="fas fa-bullseye"></i> <span id="targetCount">0</span></div>
    <div class="status-item"><i class="fas fa-shield-alt"></i> <span id="pvoCount">0</span></div>
</div>
<div class="ui-layer">
    <div class="tool-selection">
        <div class="tool-card">
            <span class="card-label">ОБОРОНА</span>
            <label><input type="radio" name="tool" value="pvo_pancyr" checked> <span>Панцирь-С1 (20км)</span></label>
            <label><input type="radio" name="tool" value="pvo_buk"> <span>Бук-М3 (70км)</span></label>
            <label><input type="radio" name="tool" value="pvo_patriot"> <span>Patriot (160км)</span></label>
            <label><input type="radio" name="tool" value="pvo_s400"> <span>С-400 (400км)</span></label>
        </div>
        <div class="tool-card">
            <span class="card-label">УГРОЗЫ</span>
            <label><input type="radio" name="tool" value="drone_mavic"> <span>Mavic (70км/ч)</span></label>
            <label><input type="radio" name="tool" value="drone_shahed"> <span>Shahed (185км/ч)</span></label>
            <label><input type="radio" name="tool" value="missile_kalibr"> <span>Калибр (850км/ч)</span></label>
            <label><input type="radio" name="tool" value="missile_iskander"> <span>Искандер (7500км/ч)</span></label>
        </div>
    </div>
    <div class="bottom-nav">
        <button class="btn" id="resetBtn"><i class="fas fa-sync-alt"></i></button>
        <button class="btn" id="playBtn"><i class="fas fa-play"></i></button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.8, 36.5], 6);
    // Светлая подложка
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    // Четкая граница
    const borderCoords = [[52.3, 33.0], [52.1, 34.2], [51.5, 34.6], [51.2, 35.3], [50.8, 35.6], [50.4, 36.5], [50.1, 37.9], [49.5, 38.6], [49.2, 39.8], [48.5, 39.4], [47.8, 40.1], [47.1, 39.2]];
    L.polyline(borderCoords, { color: '#ff4444', weight: 4, opacity: 0.8, dashArray: '10, 10', interactive: false }).addTo(map);

    const CONFIG = {
        drone_mavic: { name: 'MAVIC', speed: 70, baseAlt: 100, color: '#00e5ff' },
        drone_shahed: { name: 'SHAHED', speed: 185, baseAlt: 150, color: '#00ff88' },
        missile_kalibr: { name: 'KALIBR', speed: 850, baseAlt: 60, color: '#ffbb33' },
        missile_iskander: { name: 'ISKANDER', speed: 7500, baseAlt: 40000, color: '#ff4444' },
        pvo_pancyr: { r: 20, c: '#00ff88' }, pvo_buk: { r: 70, c: '#3b82f6' }, 
        pvo_patriot: { r: 160, c: '#ffffff' }, pvo_s400: { r: 400, c: '#ff4444' },
        interceptor: { speed: 8500 } // Увеличенная скорость ЗУР
    };

    let state = { isSimulating: false, targets: [], pvo: [], missiles: [], pendingPath: [], tempMarkers: [], activeFutureLine: null, simSeconds: 0, lastFrame: 0 };

    function getTerrainAlt(lat, lng) { return (Math.abs(Math.sin(lat * 5) * Math.cos(lng * 5)) * 200); }

    map.on('click', (e) => {
        const tool = document.querySelector('input[name="tool"]:checked').value;
        const pos = [e.latlng.lat, e.latlng.lng];
        if (tool.startsWith('pvo')) addPVO(pos, CONFIG[tool]);
        else addWaypoint(pos, tool);
    });

    function addPVO(pos, cfg) {
        L.circle(pos, { radius: cfg.r * 1000, color: cfg.c, weight: 1, fillOpacity: 0.1 }).addTo(map);
        L.circleMarker(pos, { radius: 6, color: '#fff', fillColor: cfg.c, fillOpacity: 1 }).addTo(map);
        state.pvo.push({ id: Math.random(), pos, radius: cfg.r });
        document.getElementById('pvoCount').innerText = state.pvo.length;
    }

    function addWaypoint(pos, tool) {
        const marker = L.circleMarker(pos, { radius: 4, color: CONFIG[tool].color, fillOpacity: 1 }).addTo(map);
        state.pendingPath.push(pos); state.tempMarkers.push(marker);
        if (state.activeFutureLine) map.removeLayer(state.activeFutureLine);
        state.activeFutureLine = L.polyline(state.pendingPath, { color: '#fff', weight: 1, dashArray: '5, 8', opacity: 0.5 }).addTo(map);
    }

    function spawnTarget() {
        if (state.pendingPath.length < 2) return;
        const type = document.querySelector('input[name="tool"]:checked').value;
        const info = CONFIG[type];
        const target = {
            id: Math.random(), type, path: [...state.pendingPath], speed: info.speed, color: info.color, progressKm: 0,
            currentPos: state.pendingPath[0], totalDist: 0, active: true, toolbar: createTB(),
            marker: L.circleMarker(state.pendingPath[0], { radius: 6, color: '#fff', fillColor: info.color, fillOpacity: 1 }).addTo(map),
            linePast: L.polyline([], { color: info.color, weight: 3 }).addTo(map),
            lineFuture: state.activeFutureLine, engagedBy: new Set()
        };
        for(let i=0; i<target.path.length-1; i++) target.totalDist += map.distance(target.path[i], target.path[i+1]) / 1000;
        state.targets.push(target);
        state.pendingPath = []; state.tempMarkers.forEach(m => map.removeLayer(m)); state.tempMarkers = []; state.activeFutureLine = null;
        updateCounters();
    }

    function createTB() { const div = document.createElement('div'); div.className = 'obj-toolbar'; document.body.appendChild(div); return div; }

    function simLoop(time) {
        if (!state.isSimulating) return;
        const dt = (time - state.lastFrame) / 1000; state.lastFrame = time;
        const stepHours = (dt * 12) / 3600; // Симуляция 12x

        state.targets.forEach(t => {
            if (!t.active) return;
            t.progressKm += t.speed * stepHours;
            if (t.progressKm >= t.totalDist) { markEvent(t.currentPos, 'hit'); removeT(t); } 
            else {
                t.currentPos = interpolate(t.path, t.progressKm);
                t.marker.setLatLng(t.currentPos);
                t.linePast.setLatLngs(getPoints(t.path, t.progressKm, t.currentPos, true));
                if(t.lineFuture) t.lineFuture.setLatLngs(getPoints(t.path, t.progressKm, t.currentPos, false));
                
                let alt = CONFIG[t.type].baseAlt + getTerrainAlt(t.currentPos[0], t.currentPos[1]);
                if(t.type === 'missile_iskander') alt += Math.sin(t.progressKm/t.totalDist * Math.PI) * 60000;
                
                t.toolbar.innerHTML = `${CONFIG[t.type].name} | ${t.speed} KM/H | ${Math.round(alt)} M`;
                const p = map.latLngToContainerPoint(t.currentPos);
                t.toolbar.style.left = p.x + 'px'; t.toolbar.style.top = p.y + 'px';
            }
        });

        state.pvo.forEach(p => {
            state.targets.forEach(t => {
                if (!t.active) return;
                const d = map.distance(p.pos, t.currentPos) / 1000;
                if (d < p.radius && !t.engagedBy.has(p.id)) {
                    t.engagedBy.add(p.id);
                    state.missiles.push({ targetId: t.id, pos: [...p.pos], toolbar: createTB(),
                        marker: L.circleMarker(p.pos, { radius: 3, color: '#fff', fillColor: '#ffbb33', fillOpacity: 1 }).addTo(map)
                    });
                }
            });
        });

        state.missiles = state.missiles.filter(m => {
            const t = state.targets.find(target => target.id === m.targetId && target.active);
            if (!t) { map.removeLayer(m.marker); if(m.toolbar) m.toolbar.remove(); return false; }
            const d = map.distance(m.pos, t.currentPos);
            if (d < 1000) { markEvent(t.currentPos, 'intercept'); removeT(t); map.removeLayer(m.marker); m.toolbar.remove(); return false; }
            const move = (CONFIG.interceptor.speed * stepHours * 1000) / d;
            m.pos = [m.pos[0] + (t.currentPos[0] - m.pos[0]) * move, m.pos[1] + (t.currentPos[1] - m.pos[1]) * move];
            m.marker.setLatLng(m.pos);
            m.toolbar.innerHTML = `ЗУР | LOCK`;
            const p = map.latLngToContainerPoint(m.pos);
            m.toolbar.style.left = p.x + 'px'; m.toolbar.style.top = p.y + 'px';
            return true;
        });

        state.simSeconds += dt * 12; updateUI();
        requestAnimationFrame(simLoop);
    }

    function markEvent(pos, type) {
        const icon = L.divIcon({
            html: type === 'hit' ? '<i class="fas fa-skull" style="color:#ff4444;font-size:22px;"></i>' : '<i class="fas fa-certificate" style="color:#fff;font-size:22px;"></i>',
            className: 'event-icon', iconSize: [25, 25]
        });
        L.marker(pos, { icon }).addTo(map);
        if (type === 'intercept') confetti({ particleCount: 30, spread: 60, origin: { y: 0.8 }, colors: ['#fff', '#ffbb33'] });
    }

    function getPoints(path, dist, current, past) {
        let acc = 0; let res = past ? [] : [current]; let found = false;
        for(let i=0; i<path.length-1; i++) {
            const d = map.distance(path[i], path[i+1]) / 1000;
            if (past) { res.push(path[i]); if (acc + d > dist) break; }
            else { if (acc + d > dist) found = true; if (found) res.push(path[i+1]); }
            acc += d;
        }
        if (past) res.push(current); return res;
    }

    function interpolate(path, dist) {
        let acc = 0;
        for (let i = 0; i < path.length - 1; i++) {
            const d = map.distance(path[i], path[i+1]) / 1000;
            if (acc + d > dist) { const r = (dist - acc) / d; return [path[i][0] + (path[i+1][0] - path[i][0]) * r, path[i][1] + (path[i+1][1] - path[i][1]) * r]; }
            acc += d;
        }
        return path[path.length-1];
    }

    function removeT(t) { t.active = false; map.removeLayer(t.marker); map.removeLayer(t.linePast); if(t.lineFuture) map.removeLayer(t.lineFuture); t.toolbar.remove(); updateCounters(); }
    function setSim(val) { state.isSimulating = val; const btn = document.getElementById('playBtn'); if (state.isSimulating) { spawnTarget(); state.lastFrame = performance.now(); btn.innerHTML = '<i class="fas fa-pause"></i>'; requestAnimationFrame(simLoop); } else btn.innerHTML = '<i class="fas fa-play"></i>'; }
    function updateUI() { const m = Math.floor(state.simSeconds/60); const s = Math.floor(state.simSeconds%60); document.getElementById('simTime').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
    function updateCounters() { document.getElementById('targetCount').innerText = state.targets.filter(t => t.active).length; }
    document.getElementById('playBtn').onclick = () => setSim(!state.isSimulating);
    document.getElementById('resetBtn').onclick = () => location.reload();
</script>
</body>
</html>
