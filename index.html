<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tactical Map Advanced BR</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;padding:0;height:100%;background:#111;font-family:Arial;}
#map{height:100%;width:100%;}

.panel{
  position:absolute;
  bottom:15px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.9);
  padding:12px;
  border-radius:14px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  z-index:1000;
}

select,button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  font-size:14px;
}

button{background:#2196f3;color:white;}
.reset{background:#c62828;}

.tooltip{
  position:absolute;
  background:rgba(0,0,0,0.8);
  color:white;
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
  pointer-events:none;
  white-space:nowrap;
}

@media(max-width:600px){
  .panel{width:95%;justify-content:center;}
}
</style>
</head>
<body>

<div id="map"></div>
<div class="panel">
  <select id="category">
    <option value="drone">БПЛА</option>
    <option value="cr">КР</option>
    <option value="br">БР</option>
  </select>
  <select id="speedSelect"></select>
  <button onclick="startObject()">Старт</button>
  <button class="reset" onclick="resetAll()">Сброс</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const TIME_SCALE = 60; // ускорение времени
const SOUND_SPEED = 1234; // км/ч

const map = L.map('map').setView([49,31],6);
L.tileLayer(
'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
{attribution:'© OpenStreetMap & CartoDB'}
).addTo(map);

const speedOptions={
  drone:[80,150,300],
  cr:[700],
  br:[3000,5000,10000]
};

const impactRadius={
  drone:50,
  cr:150,
  br:250
};

const categorySelect=document.getElementById("category");
const speedSelect=document.getElementById("speedSelect");

function updateSpeedOptions(){
  speedSelect.innerHTML="";
  speedOptions[categorySelect.value].forEach(s=>{
    const o=document.createElement("option");
    o.value=s;
    o.textContent=s+" км/ч";
    speedSelect.appendChild(o);
  });
}
updateSpeedOptions();
categorySelect.addEventListener("change",updateSpeedOptions);

let tempPoints=[];
let activeObjects=[];
let tooltips=[];

map.on("click",e=>{
  tempPoints.push([e.latlng.lat,e.latlng.lng]);
  L.circleMarker(e.latlng,{radius:4,color:"cyan"}).addTo(map);
});

// старт объекта
function startObject(){
  if(tempPoints.length<2){alert("Минимум 2 точки"); return;}
  const type = categorySelect.value;
  const speed = parseInt(speedSelect.value);

  const obj = {
    type:type,
    points:[...tempPoints],
    speed:speed,
    marker:L.circleMarker(tempPoints[0],{radius:5,color:"white",fillColor:"white",fillOpacity:1}).addTo(map),
    passedLine:null,
    remainingLine:null,
    impactCircle:null,
    startTime:performance.now(),
    totalDistance:calcTotal(tempPoints),
    finished:false,
    tooltip:createTooltip(tempPoints[0])
  };

  obj.marker.bringToFront();
  activeObjects.push(obj);
  animateObject(obj);
  tempPoints=[];
}

// тулбар/tooltip
function createTooltip(latlng){
  const div = document.createElement("div");
  div.className="tooltip";
  div.style.left="0px"; div.style.top="0px";
  div.innerHTML="0:00:00 | 0 км/ч";
  document.body.appendChild(div);
  return div;
}

function updateTooltip(obj,latlng,currentSpeed,time){
  const point = map.latLngToContainerPoint(latlng);
  obj.tooltip.style.left = (point.x+10)+"px";
  obj.tooltip.style.top = (point.y-20)+"px";
  obj.tooltip.innerHTML = `${formatTime(time)} | ${currentSpeed.toFixed(0)} км/ч`;
}

function removeTooltip(obj){
  if(obj.tooltip) document.body.removeChild(obj.tooltip);
}

// формат времени чч:мм:сс
function formatTime(hours){
  const totalSec = Math.floor(hours*3600);
  const h=Math.floor(totalSec/3600);
  const m=Math.floor((totalSec%3600)/60);
  const s=totalSec%60;
  return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// анимация объектов
function animateObject(obj){
  function frame(){
    if(obj.finished) return;

    const now = performance.now();
    const hours = ((now-obj.startTime)/1000/3600)*TIME_SCALE;

    let traveled;
    if(obj.type==="br"){
      traveled = getBRDistance(obj, hours);
    } else traveled = obj.speed*hours;

    if(traveled>=obj.totalDistance){
      finishObject(obj);
      return;
    }

    let acc=0;
    for(let i=0;i<obj.points.length-1;i++){
      const seg=getDistance(obj.points[i],obj.points[i+1]);
      if(acc+seg>=traveled){
        const r=(traveled-acc)/seg;
        const lat=obj.points[i][0]+(obj.points[i+1][0]-obj.points[i][0])*r;
        const lng=obj.points[i][1]+(obj.points[i+1][1]-obj.points[i][1])*r;
        const pos=[lat,lng];

        obj.marker.setLatLng(pos);
        obj.marker.bringToFront();

        drawLines(obj,i,pos);
        updateTooltip(obj,pos,obj.speed,hours);
        break;
      }
      acc+=seg;
    }
    requestAnimationFrame(frame);
  }
  frame();
}

// расчет баллистической дуги (упрощенно)
function getBRDistance(obj,hours){
  const accelPhase = 5/3600; // 5 сек до крейсерской фазы в часах
  const distance = obj.speed*(hours-accelPhase);
  return distance>0?distance:obj.speed*hours*0.5; // упрощение разгона
}

// рисование линий
function drawLines(obj,index,currentPos){
  if(obj.passedLine) map.removeLayer(obj.passedLine);
  if(obj.remainingLine) map.removeLayer(obj.remainingLine);

  const passed = obj.points.slice(0,index+1);
  passed.push(currentPos);

  const remaining = obj.points.slice(index+1);

  obj.passedLine = L.polyline(passed,{color:getColor(obj.type)}).addTo(map);

  if(remaining.length>0){
    obj.remainingLine = L.polyline([currentPos,...remaining],{color:getColor(obj.type),dashArray:"6,6"}).addTo(map);
  }
}

// завершение объекта
function finishObject(obj){
  obj.finished=true;
  if(obj.marker) map.removeLayer(obj.marker);
  if(obj.remainingLine) map.removeLayer(obj.remainingLine);
  if(obj.passedLine) map.removeLayer(obj.passedLine);

  obj.passedLine=L.polyline(obj.points,{color:getColor(obj.type),opacity:0.3}).addTo(map);

  const last=obj.points[obj.points.length-1];
  flashEffect(last,impactRadius[obj.type],getColor(obj.type));
  obj.impactCircle=L.circle(last,{radius:impactRadius[obj.type],color:getColor(obj.type),fillColor:getColor(obj.type),fillOpacity:0.3}).addTo(map);

  removeTooltip(obj);
}

// вспышка
function flashEffect(latlng,radius,color){
  let r=10;
  const maxR=radius;
  const flash=L.circle(latlng,{radius:r,color:color,fillColor:color,fillOpacity:0.8}).addTo(map);
  function expand(){
    r+=maxR/15;
    flash.setRadius(r);
    flash.setStyle({fillOpacity:0.8*(1-r/maxR)});
    if(r<maxR) requestAnimationFrame(expand);
    else map.removeLayer(flash);
  }
  expand();
}

// сброс
function resetAll(){
  map.eachLayer(layer=>{
    if(layer instanceof L.Polyline ||
       layer instanceof L.Circle ||
       layer instanceof L.CircleMarker){
      map.removeLayer(layer);
    }
  });
  activeObjects.forEach(o=>removeTooltip(o));
  activeObjects=[]; tempPoints=[];
}

// расстояние
function calcTotal(points){let d=0;for(let i=0;i<points.length-1;i++) d+=getDistance(points[i],points[i+1]);return d;}
function getDistance(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLng=(b[1]-a[1])*Math.PI/180;
  const lat1=a[0]*Math.PI/180;
  const lat2=b[0]*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.sin(dLng/2)**2 * Math.cos(lat1)*Math.cos(lat2);
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function getColor(type){
  if(type==="drone") return "cyan";
  if(type==="cr") return "orange";
  if(type==="br") return "red";
}
</script>

</body>
</html>